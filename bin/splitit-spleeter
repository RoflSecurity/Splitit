#!/data/data/com.termux/files/usr/bin/bash

URL="$1"

# Télécharger le titre propre pour nommer les fichiers
TITLE=$(yt-dlp --get-title "$URL")
SAFE_TITLE=$(echo "$TITLE" | sed 's/[^a-zA-Z0-9_-]/_/g')
WAVFILE="${SAFE_TITLE}.wav"

# Télécharger et convertir en WAV
yt-dlp -x --audio-format wav -o "$WAVFILE" "$URL"

# Créer dossier output si inexistant
mkdir -p ./output

# Séparer voix/instrumental avec Spleeter
spleeter separate -p spleeter:2stems -o ./output "$WAVFILE"

# Spleeter génère : ./output/<nom_du_fichier>/vocals.wav et accompaniment.wav
VOX="./output/$SAFE_TITLE/vocals.wav"
INST="./output/$SAFE_TITLE/accompaniment.wav"

# Convertir en MP3
ffmpeg -i "$VOX" -q:a 0 "${SAFE_TITLE}_vocals.mp3"
ffmpeg -i "$INST" -q:a 0 "${SAFE_TITLE}_instrumental.mp3"
ffmpeg -i "$WAVFILE" -q:a 0 "${SAFE_TITLE}_full.mp3"

# Supprimer fichiers WAV pour économiser de la place
rm -f "$WAVFILE" "$VOX" "$INST"

echo "✅ Fichiers générés : ${SAFE_TITLE}_vocals.mp3, ${SAFE_TITLE}_instrumental.mp3, ${SAFE_TITLE}_full.mp3"
